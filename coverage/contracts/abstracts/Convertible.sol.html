<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/abstracts/Convertible.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">contracts/abstracts/</a> Convertible.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">14.29% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>5/35</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/8</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">11.11% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>1/9</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">14.29% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>5/35</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity &gt;=0.8.7;
&nbsp;
import "@openzeppelin/contracts-upgradeable/utils/ContextUpgradeable.sol";
import "@openzeppelin/contracts-upgradeable/proxy/utils/Initializable.sol";
import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import "../libs/GluwacoinModels.sol";
import "../libs/HashMapIndex.sol";
&nbsp;
contract Convertible is Initializable, ContextUpgradeable {
    using HashMapIndex for HashMapIndex.HashMapping;
&nbsp;
    uint8 private _baseTokenDecimal;
    uint8 private _convertedTokenDecimal;
    IERC20 private _baseToken;
    GluwacoinModels.TokenExchangeModel private _exchangeRate;
&nbsp;
    HashMapIndex.HashMapping private _lockerIndex;
&nbsp;
    mapping(bytes32 =&gt; GluwacoinModels.Locker) internal _locker;
    mapping(address =&gt; bytes32) internal _lockerOwner;
&nbsp;
    event Locked(
        bytes32 indexed lockerHash,
        address indexed sender,
        uint256 _value
    );
&nbsp;
    event Mint(address indexed _mintTo, uint256 _value);
    event Burnt(address indexed _burnFrom, uint256 _value);
&nbsp;
    function __Convertible_init_unchained(
        IERC20 token,
        uint8 convertedTokenDecimal
    ) internal initializer {
        _baseToken = token;
        _convertedTokenDecimal = convertedTokenDecimal;
        _lockerIndex.firstIdx = 1;
        _lockerIndex.nextIdx = 1;
        _lockerIndex.count = 0;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function getTokenExchangeDetails()</span>
        public
        view
        returns (GluwacoinModels.TokenExchangeModel memory)
    {
<span class="cstat-no" title="statement not covered" >        return _exchangeRate;</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function getLocker(bytes32 lockerHash)</span>
        public
        view
        returns (GluwacoinModels.Locker memory)
    {
<span class="cstat-no" title="statement not covered" >        return _locker[lockerHash];</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function _setTokenExchange(</span>
        uint32 newExchangeRate,
        uint32 newExchangeRateDecimalPlaceBase
    ) internal returns (bool) {
<span class="cstat-no" title="statement not covered" >        _exchangeRate.rate = newExchangeRate</span>;
<span class="cstat-no" title="statement not covered" >        _exchangeRate.decimalPlaceBase = newExchangeRateDecimalPlaceBase</span>;
<span class="cstat-no" title="statement not covered" >        return true;</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function _lockFrom(</span>
        address account,
        uint256 amount,
        uint256 fee
    ) internal returns (bool) {
<span class="cstat-no" title="statement not covered" >        require(</span>
            _baseToken.transferFrom(account, address(this), amount),
            "Convertible: Can't lock the token amount"
        );
<span class="cstat-no" title="statement not covered" >        bytes32 lockerHash;</span>
<span class="cstat-no" title="statement not covered" >        uint256 lockedAmount = amount - fee;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        bytes32 existingLockerHash = _lockerOwner[account];</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        if (_locker[existingLockerHash].idx &gt; 0) {</span>
<span class="cstat-no" title="statement not covered" >            _locker[existingLockerHash].amount += lockedAmount</span>;
        } else {
<span class="cstat-no" title="statement not covered" >            lockerHash = keccak256(</span>
                abi.encodePacked(_lockerIndex.nextIdx, address(this), account)
            );
&nbsp;
<span class="cstat-no" title="statement not covered" >            _locker[lockerHash] = GluwacoinModels.Locker({</span>
                idx: _lockerIndex.nextIdx,
                owner: account,
                amount: lockedAmount,
                exchangeRate: _exchangeRate,
                state: GluwacoinModels.LockerState.Active
            });
&nbsp;
<span class="cstat-no" title="statement not covered" >            _lockerIndex.add(lockerHash)</span>;
<span class="cstat-no" title="statement not covered" >            _lockerOwner[account] = lockerHash</span>;
        }
&nbsp;
<span class="cstat-no" title="statement not covered" >        emit Mint(account, amount);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        emit Locked(lockerHash, account, lockedAmount);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        return true;</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function _withdraw(</span>
        address account,
        uint256 amount,
        uint256 fee
    ) internal returns (bool) {
<span class="cstat-no" title="statement not covered" >        bytes32 lockerHash = _lockerOwner[account];</span>
<span class="cstat-no" title="statement not covered" >        require(</span>
            _locker[lockerHash].amount &gt;= amount,
            "Convertible: Can't withdraw token from the locker"
        );
<span class="cstat-no" title="statement not covered" >        uint256 withdrawnAmount = _calculateWithdrawal(</span>
            amount,
            _locker[lockerHash].exchangeRate.rate,
            _locker[lockerHash].exchangeRate.decimalPlaceBase
        );
<span class="cstat-no" title="statement not covered" >        require(</span>
            withdrawnAmount &gt; fee,
            "Convertible: Withdrawn amount must be higher than fee"
        );
<span class="cstat-no" title="statement not covered" >        _locker[lockerHash].amount -= withdrawnAmount</span>;
<span class="cstat-no" title="statement not covered" >        _baseToken.transfer(account, withdrawnAmount - fee)</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        emit Burnt(account, amount);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        return true;</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function _withdrawBaseToken(address collector, uint256 amount)</span>
        internal
        returns (bool)
    {
<span class="cstat-no" title="statement not covered" >        _baseToken.transfer(collector, amount)</span>;
<span class="cstat-no" title="statement not covered" >        return true;</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function _calculateConversion(uint256 amount)</span>
        internal
        view
        returns (uint256)
    {
<span class="cstat-no" title="statement not covered" >        return (amount * _exchangeRate.rate) / _exchangeRate.decimalPlaceBase;</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function _calculateWithdrawal(</span>
        uint256 amount,
        uint32 rate,
        uint32 decimalPlaceBase
    ) internal pure returns (uint256) {
<span class="cstat-no" title="statement not covered" >        return (amount * decimalPlaceBase) / rate;</span>
    }
&nbsp;
    uint256[50] private __gap;
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Thu Sep 02 2021 02:06:25 GMT-0400 (Eastern Daylight Time)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
